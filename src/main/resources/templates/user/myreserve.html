<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>我的预约</title>
<link rel="stylesheet" href="css/user/mycollect.css" />
</head>
<body>

    <input type="text" id="i1" th:value="${session.user_id}" hidden="true"><br /> 

    <div class="t">
        <table>
        </table>
    </div>
	
	<div class="btu">
        <button id="btu_up" class="btu1">&lt;</button>
        &nbsp;<span id="span1">1</span><span>/</span><span id="span2">-</span>&nbsp;
        <button id="btu_down" class="btu1">&gt;</button>
    </div>
    
    
    <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
    <script>
	    
	    var page
	    $(document).ready(function () {
	        let str = `<tr><th>预约编号</th><th>房屋编号</th><th>预约看房时间</th><th>状态</th><th>操作</th>/tr>`
	        $.ajax({
	            type: "get",
	            url: "https://localhost:8080/api/v1/reserve/" + $("#i1").val(),
	            success: function (response) {
	                let reserves = response;
	                if (reserves.length == 0) {
	                    str += `<tr><td colspan="4">暂无预约记录</td></tr>`
	                } else {
	                	reserves.forEach(reserve => {
	                		var status = reserve.status;
	                		if(status == "1"){
	                		    status = "预约成功";
	                		}else if((status == "0")){
	                			status = "处理中";
	                		}
	                		else{
	                			status = "预约失败";
	                		}
	                		
	                        str += `<tr><td>${reserve.reserve_id}</td><td>${reserve.house_id}</td>
	                                <td>${reserve.reserve_time}</td><td>${status}</td>
	                                <td><a href="#" onclick='releasedeletetr(this)'>取消预约</a></td>
	                                </tr>`;
	                    });
	                }
	                $("table").html(str);
	            }
	        });
	    });
	
		$(document).ready(function () {
	        $.ajax({
	            type: "get",
	            url: "https://localhost:8080/api/v1/reserve/getcount/" + $("#i1").val(),
	            success: function (response) {
                	if(response % 10==0 && response!=0)
                		page = parseInt(response / 10);
                	else
                    	page = parseInt(response / 10) + 1
                    $("#span2").text(page);
                },
	            error: function (response) {
	                alert("查询失败")
	            }
	        });
	    });
	    
    	$(document).ready(function () {
            $("#btu_down").click(function (e) {
                if (parseInt($("#span1").text()) >= page) {
                    alert("这是最后一页")
                } else {
                    $("#span1").text(parseInt($("#span1").text()) + 1);
                    var curpage_down = $("#span1").text();
                    let str = `<tr><th>预约编号</th><th>房屋编号</th><th>预约看房时间</th><th>状态</th><th>操作</th>/tr>`
                    $.ajax({
                        type: "get",
                        url: "https://localhost:8080/api/v1/reserve/" + $("#i1").val() + "?start=" + (curpage_down - 1) * 10,
                        success: function (response) {
        	                let reserves = response;
        	                if (reserves.length == 0) {
        	                    str += `<tr><td colspan="4">暂无预约记录</td></tr>`
        	                } else {
        	                	reserves.forEach(reserve => {
        	                		var status = reserve.status;
        	                		if(status == "1"){
        	                		    status = "预约成功";
        	                		}else if((status == "0")){
        	                			status = "处理中";
        	                		}
        	                		else{
        	                			status = "预约失败";
        	                		}
        	                		
        	                		
        	                        str += `<tr><td>${reserve.reserve_id}</td><td>${reserve.house_id}</td>
        	                                <td>${reserve.reserve_time}</td><td>${status}</td>
        	                                <td><a href="#" onclick='releasedeletetr(this)'>取消预约</a></td>
        	                                </tr>`;
        	                    });
        	                }
        	                $("table").html(str);
        	            }
                    });
                }
            });
        });
    	
    	$(document).ready(function () {
            $("#btu_up").click(function (e) {
                if (parseInt($("#span1").text()) <= 1) {
                    alert("这是第一页")
                } else {
                    $("#span1").text(parseInt($("#span1").text()) - 1);
                    var curpage_up = $("#span1").text();
                    let str = `<tr><th>预约编号</th><th>房屋编号</th><th>预约看房时间</th><th>状态</th><th>操作</th>/tr>`
                    $.ajax({
                        type: "get",
                        url: "https://localhost:8080/api/v1/reserve/" + $("#i1").val() + "?start=" + (curpage_up - 1) * 10,
                        success: function (response) {
        	                let reserves = response;
        	                if (reserves.length == 0) {
        	                    str += `<tr><td colspan="4">暂无预约记录</td></tr>`
        	                } else {
        	                	reserves.forEach(reserve => {
        	                		var status = reserve.status;
        	                		if(status == "1"){
        	                		    status = "预约成功";
        	                		}else if((status == "0")){
        	                			status = "处理中";
        	                		}
        	                		else{
        	                			status = "预约失败";
        	                		}
        	                		
        	                        str += `<tr><td>${reserve.reserve_id}</td><td>${reserve.house_id}</td>
        	                                <td>${reserve.reserve_time}</td><td>${status}</td>
        	                                <td><a href="#" onclick='releasedeletetr(this)'>取消预约</a></td>
        	                                </tr>`;
        	                    });
        	                }
        	                $("table").html(str);
        	            }
                    });
                }
            });
        });
    		    
	    
    	function releasedeletetr(tdobject){   		
    	    var $td = $(tdobject).parent().parent().children();
    	    var nid = $td.eq(0).text();
    	    var nid2 = $td.eq(1).text();    	    
    	    var nid5 = $td.eq(3).text();
    	    
    	    console.log(nid5);
    	    console.log(nid); 
    	    var t=$(tdobject);
    	    
    	    if(nid5 == "预约失败"){
    	    	t.parents("tr").remove();
        	    $.ajax({
                    type: "delete",
                    url: "https://localhost:8080/api/v1/reserve/" + nid,
                    success: function (response) {
                    	alert("已删除该预约记录!!!")                  	
                    }
        	    });
    	    }
    	    else if(nid5 == "处理中"){
    	    	alert("耐心等待预约时间审核");
    	    }
    	    
    	    else{
    	    	t.parents("tr").remove();
        	    $.ajax({
                    type: "delete",
                    url: "https://localhost:8080/api/v1/reserve/" + nid,
                    success: function (response) {
                    	alert("取消预约成功!!!")                  	
                    	 $.ajax({
                             type: "put",
                             url: "https://localhost:8080/api/v1/house/notorder/" + nid2,
                             success: function (response) {
                             	
                             }
                 	    });
                    }
        	    });
    	    }
    	}
	</script>
</body>
</html>