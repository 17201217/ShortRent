<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>我的订单--未支付订单</title>
<link rel="stylesheet" href="css/user/mycollect.css" />
</head>

<body>
	<input type="text" id="i1" th:value="${session.user_id}" hidden="true"><br /> 

    <div class="t">
        <table>
        </table>
    </div>
	
	<div class="btu">
        <button id="btu_up" class="btu1">&lt;</button>
        &nbsp;<span id="span1">1</span><span>/</span><span id="span2">-</span>&nbsp;
        <button id="btu_down" class="btu1">&gt;</button>
    </div>
	
    <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
    <script>
    	var page
        $(document).ready(function () {
            let str = `<tr><th>订单编号</th><th>房屋编号</th><th>订单生成时间</th>
                    <th>入住日期</th><th>退房日期</th><th>花费（元）</th><th>操作</th></tr>`
            $.ajax({
                type: "get",
                url: "https://localhost:8080/api/v1/orderlist/notpay/" + $("#i1").val(),
                success: function (response) {
                    let orders = response;
                    if (orders.length == 0) {
                        str += `<tr><td colspan="6">暂无订单</td></tr>`
                    } else {
                        orders.forEach(order => {
                            str += `<tr><td>${order.order_id}</td><td>${order.house_id}</td>
                                    <td>${order.order_time}</td><td>${order.starttime}</td>
                                    <td>${order.endtime}</td><td>${order.totalcost}</td>
                                    <td><a href="#" onclick='releasedeletetr(this)'>取消订单</a>&nbsp;&nbsp;|&nbsp;&nbsp;
                                    <a href="#" onclick='pay(this)'>去支付</a></td>
                                    </tr>`;
                        });
                    }
                    $("table").html(str);
                }
            });
        });
	
    	
    	$(document).ready(function () {
            $.ajax({
                type: "get",
                url: "https://localhost:8080/api/v1/orderlist/getcount2/" + $("#i1").val(),
                success: function (response) {
                	if(response % 10==0 && response!=0)
                		page = parseInt(response / 10);
                	else
                    	page = parseInt(response / 10) + 1
                    $("#span2").text(page);
                },
                error: function (response) {
                    alert("查询失败")
                }
            });
        });
    	
    	$(document).ready(function () {
            $("#btu_down").click(function (e) {
                if (parseInt($("#span1").text()) >= page) {
                    alert("这是最后一页")
                } else {
                    $("#span1").text(parseInt($("#span1").text()) + 1);
                    var curpage_down = $("#span1").text();
                    let str = `<tr id="s"><th>订单编号</th><th>房屋编号</th><th>订单生成时间</th>
                    <th>入住日期</th><th>退房日期</th><th>花费（元）</th><th>操作</th></tr>`
                    $.ajax({
                        type: "get",
                        url: "https://localhost:8080/api/v1/orderlist/notpay/" + $("#i1").val() + "?start=" + (curpage_down - 1) * 10,
                        success: function (response) {
                            let orders = response;
                            if (orders.length == 0) {
                                str += `<tr><td colspan="6">暂无订单</td></tr>`
                            } else {
                                orders.forEach(order => {
                                    str += `<tr><td>${order.order_id}</td><td>${order.house_id}</td>
                                    <td>${order.order_time}</td><td>${order.starttime}</td>
                                    <td>${order.endtime}</td><td>${order.totalcost}</td>
                                    <td><a href="#" onclick='releasedeletetr(this)'>取消订单</a>&nbsp;&nbsp;|&nbsp;&nbsp;
                                    <a href="#" onclick='pay(this)'>去支付</a></td>
                                    </tr>`;
                                });
                            }
                            $("table").html(str);
                        }
                    });
                }
            });
        });
    	
    	$(document).ready(function () {
            $("#btu_up").click(function (e) {
                if (parseInt($("#span1").text()) <= 1) {
                    alert("这是第一页")
                } else {
                    $("#span1").text(parseInt($("#span1").text()) - 1);
                    var curpage_up = $("#span1").text();
                    let str = `<tr id="s"><th>订单编号</th><th>房屋编号</th><th>订单生成时间</th>
                    <th>入住日期</th><th>退房日期</th><th>花费（元）</th><th>操作</th></tr>`
                    $.ajax({
                        type: "get",
                        url: "https://localhost:8080/api/v1/orderlist/notpay/" + $("#i1").val() + "?start=" + (curpage_up - 1) * 10,
                        success: function (response) {
                            let orders = response;
                            if (orders.length == 0) {
                                str += `<tr><td colspan="6">暂无订单</td></tr>`
                            } else {
                                orders.forEach(order => {
                                    str += `<tr><td>${order.order_id}</td><td>${order.house_id}</td>
                                    <td>${order.order_time}</td><td>${order.starttime}</td>
                                    <td>${order.endtime}</td><td>${order.totalcost}</td>
                                    <td><a href="#" onclick='releasedeletetr(this)'>取消订单</a>&nbsp;&nbsp;|&nbsp;&nbsp;
                                    <a href="#" onclick='pay(this)'>去支付</a></td>
                                    </tr>`;
                                });
                            }
                            $("table").html(str);
                        }
                    });
                }
            });
        });
    	

    	function releasedeletetr(tdobject){   		
    	    var $td = $(tdobject).parent().parent().children();
    	    var nid = $td.eq(0).text();
    	    var nid2 = $td.eq(1).text();//获取房屋编号，让它下架
    	    var money = parseInt($td.eq(4).text()*0.02);
    	    var t=$(tdobject);
    	    t.parents("tr").remove();
    	    $.ajax({
                type: "delete",
                url: "https://localhost:8080/api/v1/orderlist/" + nid,
                success: function (response) {
                	alert("取消订单成功");
                	  $.ajax({
                          type: "put",
                          url: "https://localhost:8080/api/v1/house/notrent/" + nid2,
                          success: function (response) {
                          	
                          }
              	    });
                }
    	    });
    	}

    	function pay(tdobject){
    	    var $td = $(tdobject).parent().parent().children();
    	    var nid0 = $td.eq(0).text();
    	    var nid5 = $td.eq(5).text();

            window.open ("/pay?price=" + nid5 + "&orderId=" + nid0,"newwindow",
                		"height=700, width=1200, top=100, left=120, toolbar=no, menubar=no, resizable=no")

    	}

    </script>
</body>

</html>